<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="chrome=1"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="referrer" content="no-referrer"><meta name="theme-color" content="#333333"><meta name="mobile-web-app-capable" content="yes"><meta name="google" content="notranslate"><meta name="format-detection" content="telephone=no"><meta name="keyword" content="Web, Js, CSS, Node.js, Frontend, Flutter, Docker"><meta name="description" content="想写什么就写什么"><title>使用 Codemagic 持续部署 Flutter 应用 (上) - 冷石的博客</title><base href="/"><link rel="preconnect" href="//cdn.bootcss.com"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/icons/icon-72x72.png"><link rel="apple-touch-icon" href="/icons/icon-192x192.png"><link href="https://cdn.bootcss.com/highlight.js/9.15.10/styles/atom-one-light.min.css" rel="stylesheet"><link href="https://cdn.bootcss.com/highlight.js/9.15.10/styles/atom-one-dark.min.css" rel="stylesheet" media="screen and (prefers-color-scheme:dark)"><link href="https://cdn.bootcss.com/uikit/3.2.0/css/uikit.min.css" rel="stylesheet"><script src="https://cdn.bootcss.com/uikit/3.2.0/js/uikit.min.js" async></script><script src="https://cdn.bootcss.com/uikit/3.2.0/js/uikit-icons.min.js" async></script><link rel="stylesheet" href="/styles/cold-stone.css"><noscript><p class="text-center">你的浏览器还没开启 Javascript 功能！</p></noscript><meta name="generator" content="Hexo 4.0.0"></head><body><header class="header" uk-sticky="top: 100; animation: uk-animation-slide-top; bottom: #sticky-on-scroll-up"><nav class="wrapper header-content"><div class="nav-overlay uk-navbar-left"><h1 class="title nav-list-item uk-logo" data-link="/"><a href="/" data-link="/">冷石</a></h1><ul class="nav-list"><li class="nav-list-item" data-link="/categories/"><a class="nav-list-link" href="/categories">分类</a></li><li class="nav-list-item" data-link="/friends/"><a class="nav-list-link" href="/friends">友链</a></li><li class="nav-list-item" data-link="/about/"><a class="nav-list-link" href="/about/">关于</a></li><li class="nav-list-item" data-link="/rss/"><a class="nav-list-link" href="/atom.xml">RSS</a></li></ul></div><div class="uk-navbar-right translate-x"><a class="uk-navbar-toggle" href="#modal-full" uk-search-icon uk-toggle></a></div></nav><div class="header-bar"></div></header><div id="modal-full" class="uk-modal-full uk-modal" uk-modal><div class="uk-modal-dialog uk-flex uk-flex-center uk-flex-middle" uk-height-viewport><button class="uk-modal-close-full" type="button" uk-close></button><form class="uk-search uk-search-large search-form" action="//google.com/search" method="get" accept-charset="UTF-8" target="_blank"><input class="uk-search-input search-form-input" type="search" name="q" placeholder="搜索" autofocus autocomplete="false"> <input type="hidden" name="sitesearch" value="https://coldstone.fun"></form></div></div><main class="main wrapper"><article class="article slide-in-right uk-article"><section class="article-header"><h1 class="article-title uk-article-title">使用 Codemagic 持续部署 Flutter 应用 (上)</h1><p class="article-meta uk-article-meta"><span class="meta-info"><span>最后更新&#58;<time class="post-time" datetime="2020-02-14">2020-02-14</time> </span><span>阅读时间&#58; 3 min</span> <span class="hide" id="busuanzi_container_page_pv">阅读量&#58; <span id="busuanzi_value_page_pv"></span></span></span></p></section><section class="article-content"><h2 id="什么是-Codemagic"><a href="#什么是-Codemagic" class="headerlink" title="什么是 Codemagic"></a>什么是 <code>Codemagic</code></h2><p><a href="https://codemagic.io" target="_blank" rel="noopener">Codemagic</a> 是一个为 <code>Flutter</code> 项目以及其它移动端项目提供 CI/CD 服务的平台。</p><p>可以使用 Github 账号注册登录，登录后它会要求获得你仓库的读/写权限，然后在 <a href="https://codemagic.io/apps" target="_blank" rel="noopener">apps</a> 页面显示你需要进行构建的项目。</p><p><img src="./images/code-apps.jpg" alt="code-apps"></p><h2 id="为什么使用-Codemagic"><a href="#为什么使用-Codemagic" class="headerlink" title="为什么使用 Codemagic"></a>为什么使用 <code>Codemagic</code></h2><p>好的 <code>CI/CD</code> 有助于更快地构建，测试以及部署发布应用。在 <code>Flutter</code> 的官方文档 <a href="https://flutter.cn/docs/deployment/cd" target="_blank" rel="noopener">Flutter 里的持续部署</a> 里介绍了使用 <code>fastlane</code> 工具进行本地部署以及如何将 <code>fastlane</code> 整合到 <code>Travis</code>，<code>Cirrus</code>，<code>Bitrise</code> 等持续交付的服务中，但是对于 <code>Flutter</code> 项目来说最方便的 <code>CI/CD</code> 服务应该还是 <code>Codemagic</code>，它可以直接在网页上就配置出完整的应用交付流程。</p><h2 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h2><p>选择需要构建的 <code>Fluter</code> 项目，点击 <code>Start your first build</code> 按钮，创建一个工作流程 <code>Workflow</code>。<br>一个 <code>Workflow</code> 指的是每次构建要做的任务，如执行构建，测试以及发布任务。</p><p>对于 <code>Flutter</code> 项目可以在网页上配置或使用 <code>codemagic.yaml</code> 配置文件，其它项目只能使用 <code>codemagic.yaml</code> 配置。</p><p><img src="./images/workflow.jpg" alt="workflow"></p><p>一个 <code>Workflow</code> 由以下几个部分组成</p><ol><li><code>Build triggers</code> –&gt; 指定的构建分支和触发构建的时机</li></ol><p><img src="./images/build-triggers.jpg" alt="build-triggers"></p><ol start="2"><li><code>Environment variables</code> –&gt; 设置构建时的环境变量</li></ol><p><img src="https://docs.codemagic.io/uploads/env_vars.PNG" alt="env_vars"></p><ol start="3"><li><code>Dependency caching</code> –&gt; 设置构建时的依赖缓存文件目录，加快构建速度</li></ol><p><img src="https://docs.codemagic.io/uploads/2019/04/caching_enabled.PNG" alt="caching"></p><ol start="4"><li><code>Test</code> –&gt; 执行应用的单元，集成和部件测试，以及静态代码分析</li></ol><p><img src="./images/code-test.jpg" alt="code-test"></p><ol start="5"><li><code>Build</code> –&gt; 配置应用构建时的 Flutter 版本，构建目标，构建参数</li></ol><p><img src="./images/code-build.jpg" alt="code-build"></p><ol start="6"><li><code>Publish</code> –&gt; 选择需要发布应用的目标，这里我选择了 <code>Google play</code></li></ol><p><img src="./images/code-publish.jpg" alt="code-publish"></p><h2 id="代码签名"><a href="#代码签名" class="headerlink" title="代码签名"></a>代码签名</h2><p>要将应用发布到 <code>Apple store</code> 或者 <code>Goople play</code> 上就必须对你的应用进行代码签名，代码签名目的是为了识别谁开发了该应用程序，并确保该应用程序的所有更新均来自这个人。</p><p>对于 Android 来说有两种签名：发布签名和上传签名。最终用户下载的 <code>.aab/.apk</code> 文件使用发布签名。上传签名提供给开发者上传到 <code>Google Play</code> 商店的认证。上传后，<code>Google Play</code> 会重新使用发布签名对 <code>.aab/.apk</code> 文件签名。</p><p>在配置 <code>Workflow</code> 时，我选择发布到 <code>Goople play</code> 所以需要对 Android 应用进行代码签名，有以下两种方式进行签名，选择其一即可。</p><ol><li>使用 <code>Android Studio</code> <a href="https://developer.android.google.cn/studio/publish/app-signing#sign-apk" target="_blank" rel="noopener">为您的应用签名</a></li><li>使用命令行工具进行签名 <a href="https://flutter.cn/docs/deployment/android#signing-the-app" target="_blank" rel="noopener">为 app 签名</a></li></ol><p>签名后需要做的是把签名信息存到工作流程 <code>Workflow</code> 内，<a href="https://docs.codemagic.io/code-signing/android-code-signing/" target="_blank" rel="noopener">Android code signing</a>。</p><h2 id="创建-Service-Account"><a href="#创建-Service-Account" class="headerlink" title="创建 Service Account"></a>创建 <code>Service Account</code></h2><p><code>Service Account</code> 是给 <code>CI/CD</code> 平台发布构建后应用用的，根据指引创建 <a href="https://docs.codemagic.io/publishing/publishing-to-google-play/#setting-up-a-service-account-in-google-play-console" target="_blank" rel="noopener">Setting up a service account in Google Play Console</a>，创建后需做的上传你的凭证 JSON 文件</p><p><img src="./images/code-google-play.jpg" alt="code-google-play"></p><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol><li>在使用 <code>CI/CD</code> 服务前首先要人工的上传应用到 <code>Google Play</code> 一次。</li><li>每次上传到 <code>Google Play</code> 的应用构建版本不能重复，否则会遇到这样一个问题</li></ol><pre><code class="sh">Google Play responded with: APK specifies a version code that has already been used.</code></pre><p>搜索一番后发现问题是应用构建的版本号重复，需要更新 <code>pubspec.yaml</code> 文件的 <code>version</code> 字段的值，详细说明可以查阅这篇文章 <a href="https://flutter.cn/docs/deployment/android#updating-the-apps-version-number" target="_blank" rel="noopener">更新应用版本号</a></p><ol start="3"><li>上传 <code>Google Play</code> 需要添加一个环境变量 <code>FCI_KEYSTORE_FILE</code>，这个变量需要用 base64 encode 一下，需要用到的命令是<pre><code class="sh">base64 input-file-path -o output.txt</code></pre></li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>使用 <code>Codemagic</code> 发布 Flutter 应用的流程大致如下</p><ol><li>选择构建项目</li><li>配置构建流程</li><li>进行代码签名</li><li>创建 Service Account</li><li>触发构建</li></ol><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://flutter.cn/docs/deployment/cd" target="_blank" rel="noopener">Flutter 里的持续部署</a></p><p><a href="https://docs.codemagic.io/" target="_blank" rel="noopener">Codemagic Documentation</a></p></section></article><section class="prev-next card slide-in-right"><a class="link-disabled prev link">&larr; 没有更多了</a> <a href="/post/2020/01/26/flutter-show-search/" class="link next" title="为 Flutter 应用添加搜索功能"><span class="hover-underline-animation">为 Flutter 应用添加搜索功能 &rarr;</span></a></section><section class="article-toc"><div class="card uk-margin-remove-bottom"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是-Codemagic"><span class="toc-text">什么是 Codemagic</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么使用-Codemagic"><span class="toc-text">为什么使用 Codemagic</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#如何使用"><span class="toc-text">如何使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码签名"><span class="toc-text">代码签名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建-Service-Account"><span class="toc-text">创建 Service Account</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#注意"><span class="toc-text">注意</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol></div></section><section class="article slide-in-right"><div class="loader" id="loader"><svg viewBox="0 0 50 50"><circle class="ring" cx="25" cy="25" r="20"></circle><circle class="ball" cx="25" cy="5" r="3.5"></circle></svg></div><div class="comment" id="utteranc"></div><noscript>Please activate JavaScript for normal use of comments</noscript></section><a class="card back-to-top" id="backTop">&UpArrow;</a></main><script>window.COLD_STONE={root:"/",author:"Cold Stone",gaid:"UA-119658292-2",repo:"xrr2016/blog"}</script><script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script><script>hljs.initHighlightingOnLoad()</script><script src="/scripts/busuanzi.js" referrerpolicy="origin"></script><script src="/scripts/cold-stone.js"></script><script src="//www.googletagmanager.com/gtag/js?id=UA-119658292-2"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config",window.COLD_STONE.gaid)</script></body></html>