<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="chrome=1"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="referrer" content="no-referrer"><meta name="theme-color" content="#333333"><meta name="mobile-web-app-capable" content="yes"><meta name="google" content="notranslate"><meta name="format-detection" content="telephone=no"><meta name="keyword" content="Web, Js, CSS, Node.js, Frontend, Flutter, Docker"><meta name="description" content="想写什么就写什么"><title>对 Egg.js 进行单元测试 - 冷石的博客</title><base href="/"><link rel="preconnect" href="//cdn.bootcss.com"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/icons/icon-72x72.png"><link rel="apple-touch-icon" href="/icons/icon-192x192.png"><link href="https://cdn.bootcss.com/highlight.js/9.15.10/styles/atom-one-light.min.css" rel="stylesheet"><link href="https://cdn.bootcss.com/highlight.js/9.15.10/styles/atom-one-dark.min.css" rel="stylesheet" media="screen and (prefers-color-scheme:dark)"><link href="https://cdn.bootcss.com/uikit/3.2.0/css/uikit.min.css" rel="stylesheet"><script src="https://cdn.bootcss.com/uikit/3.2.0/js/uikit.min.js" async></script><script src="https://cdn.bootcss.com/uikit/3.2.0/js/uikit-icons.min.js" async></script><link rel="stylesheet" href="/styles/cold-stone.css"><noscript><p class="text-center">你的浏览器还没开启 Javascript 功能！</p></noscript><meta name="generator" content="Hexo 4.0.0"></head><body><header class="header" uk-sticky="top: 100; animation: uk-animation-slide-top; bottom: #sticky-on-scroll-up"><div class="header-bar"></div><nav class="wrapper header-content"><div class="nav-overlay uk-navbar-left"><h1 class="title nav-list-item uk-logo" data-link="/"><a href="/" data-link="/">冷石</a></h1><ul class="nav-list"><li class="nav-list-item" data-link="/categories/"><a class="nav-list-link" href="/categories">分类</a></li><li class="nav-list-item" data-link="/friends/"><a class="nav-list-link" href="/friends">友链</a></li><li class="nav-list-item" data-link="/about/"><a class="nav-list-link" href="/about/">关于</a></li><li class="nav-list-item" data-link="/rss/"><a class="nav-list-link" href="/atom.xml">RSS</a></li></ul></div><div class="uk-navbar-right translate-x"><a class="uk-navbar-toggle" href="#modal-full" uk-search-icon uk-toggle></a></div></nav></header><div id="modal-full" class="uk-modal-full uk-modal" uk-modal><div class="uk-modal-dialog uk-flex uk-flex-center uk-flex-middle" uk-height-viewport><button class="uk-modal-close-full" type="button" uk-close></button><form class="uk-search uk-search-large search-form" action="//google.com/search" method="get" accept-charset="UTF-8" target="_blank"><input class="uk-search-input search-form-input" type="search" name="q" placeholder="搜索" autofocus autocomplete="false"> <input type="hidden" name="sitesearch" value="https://coldstone.fun"></form></div></div><main class="main wrapper"><article class="article slide-in-right uk-article"><section class="article-header"><h1 class="article-title uk-article-title">对 Egg.js 进行单元测试</h1><p class="article-meta uk-article-meta"><span class="meta-info"><span>最后更新&#58;<time class="post-time" datetime="2020-01-26">2020-01-26</time> </span><span>阅读时间&#58; 3 min</span> <span class="hide" id="busuanzi_container_page_pv">阅读量&#58; <span id="busuanzi_value_page_pv"></span></span></span></p></section><section class="article-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>优秀的代码需要有单元测试进行质量保证，每个测试用例都给应用的稳定性提供了一层保障。</p><h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><p>egg.js 工程的测试代码都是放在工程的 test 目录下，命名的方式为 <code>${filename}.test.js</code>，比如我想测试项目的 <code>user</code> <code>controller</code> 就在 <code>test</code> 目录下新建一个 <code>controller/user.test.js</code>，同理要测 <code>service</code> 就是创建一个 <code>service</code> 目录，然后就是写具体的测试代码了。</p><p>假设现在需要对一个 <code>UserService</code> 进行测试，首先在 <code>user.test.js</code> 中引入 <code>egg-mock</code> 模块用来创建一个 <code>app</code> 实例以及一个 <code>ctx</code> 对象，一般在请求接口的时候会在 <code>ctx</code> 对象上携带这次请求的参数和是用户信息，需要在创建 <code>ctx</code> 的时候添加所要的数据，最好的方式是 <code>before</code> 函数中，将这些数据附加到 <code>ctx</code> 上。</p><pre><code class="js">const { app, assert } = require(&#39;egg-mock/bootstrap&#39;)

let ctx

before(() =&gt; {
  ctx = app.mockContext({
    user: {
      name: &#39;your-name&#39;
    }
  })
})</code></pre><p>如果还需要添加请求头信息，比如用户的 <code>token</code> 可以这样添加</p><pre><code class="js">ctx.request.headers = {
  authorization: yourToken
}</code></pre><p>准备完毕，接下来编写具体的测试代码了，假如 <code>UserService</code> 有一个 <code>create</code> 方法，作用是创建一个新的 <code>user</code>，参数是请求体传过来的新建用户数据，那么可以这样写测试代码</p><pre><code class="js">it(&#39;create 方法返回新增用户成功信息&#39;, async () =&gt; {
  const data = {
    name: &#39;user name&#39; + Date.now(),
    age: parseInt(Math.random() * 60),
    gender: Math.random() &gt; 0.5 ? &#39;male&#39; : &#39;female&#39;
  }

  const response = await ctx.service.user.create(data)

  assert(response.success === true)
  assert(response.payload.length &gt; 0)
})</code></pre><p>完整的代码</p><pre><code>'use strict';

const { app, assert } = require('egg-mock/bootstrap');

describe('用户服务测试', () => {

  let ctx

  before(() => {
    ctx = app.mockContext({
      user: {
        name: 'your-name',
      },
    });

    ctx.request.headers = {
      authorization: yourToken
    };
  })

  it('create 方法返回新增用户成功信息', async () => {
    const data = {
      name: 'user name' + Date.now(),
      age: parseInt(Math.random() * 60),
      gender: Math.random() > .5 ? 'male' : 'female'
    };

    const response = await ctx.service.user.create(data);

    assert(response.success === true);
    assert(response.payload.length > 0);
  });

})</code></pre><p>断言返回值的 <code>success</code> 为 <code>true</code>，<code>payload</code> 的 <code>length</code> 属性长度大于 0，当然这需要根据具体的业务来写，一个 <code>service</code> 可能会有很多的方法，需要尽可能多的对这些方法进行测试。</p><p>最后就是执行测试代码了</p><pre><code class="sh">npm run test</code></pre><p>通过命令 <code>npm run test</code> 执行 <code>egg-bin test</code>，或者在 <code>Idea</code> 添加一个测试的 <code>configuration</code> 点击执行即可，这样 <code>test</code> 目录下的所有测试都会运行。运行全部的测试耗时可能会很长或者有时只需要对一个测试文件进行测试，这时通过指定测试文件的路径即可</p><pre><code class="sh">npm run test &lt;TestFilePath&gt;</code></pre><p>运行测试的时候会加载 <code>config.unittest.js</code> 里面的配置，运行完毕，没有通过的测试会显示具体的错误信息，可以方便的定位错误，如果测试都通过了就会出现测试通过的以及耗时信息</p><p><img src="images/egg-test.jpg" alt="test"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://eggjs.org/zh-cn/core/unittest.html" target="_blank" rel="noopener">单元测试</a></p></section></article><section class="prev-next card slide-in-right"><a href="/post/2019/11/11/simple-use-ffmpeg/" class="link prev" title="使用 FFmpeg 转换视频格式"><span class="hover-underline-animation">&larr; 使用 FFmpeg 转换视频格式</span> </a><a href="/post/2019/10/25/docker-arg-vs-env/" class="link next" title="Docker ARG vs ENV"><span class="hover-underline-animation">Docker ARG vs ENV &rarr;</span></a></section><section class="article-toc"><div class="card uk-margin-remove-bottom"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实践"><span class="toc-text">实践</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol></div></section><section class="article slide-in-right"><div class="loader" id="loader"><svg viewBox="0 0 50 50"><circle class="ring" cx="25" cy="25" r="20"></circle><circle class="ball" cx="25" cy="5" r="3.5"></circle></svg></div><div class="comment" id="utteranc"></div><noscript>Please activate JavaScript for normal use of comments</noscript></section><a class="card back-to-top" id="backTop">&UpArrow;</a></main><script>window.COLD_STONE={root:"/",author:"Cold Stone",gaid:"UA-119658292-2",repo:"xrr2016/blog"}</script><script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script><script>hljs.initHighlightingOnLoad()</script><script src="/scripts/busuanzi.js" referrerpolicy="origin"></script><script src="/scripts/cold-stone.js"></script><script src="//www.googletagmanager.com/gtag/js?id=UA-119658292-2"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config",window.COLD_STONE.gaid)</script></body></html>