<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="chrome=1"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="referrer" content="no-referrer"><meta name="theme-color" content="#333333"><meta name="mobile-web-app-capable" content="yes"><meta name="google" content="notranslate"><meta name="format-detection" content="telephone=no"><meta name="keyword" content="Web, Js, CSS, Node.js, Frontend, Flutter, Docker"><meta name="description" content="想写什么就写什么"><title>Flutter 创建自定义路由过渡动画 - 冷石的博客</title><base href="/"><link rel="preconnect" href="//cdn.bootcss.com"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/icons/icon-72x72.png"><link rel="apple-touch-icon" href="/icons/icon-192x192.png"><link href="https://cdn.bootcss.com/highlight.js/9.15.10/styles/atom-one-light.min.css" rel="stylesheet"><link href="https://cdn.bootcss.com/highlight.js/9.15.10/styles/atom-one-dark.min.css" rel="stylesheet" media="screen and (prefers-color-scheme:dark)"><link href="https://cdn.bootcss.com/uikit/3.2.0/css/uikit.min.css" rel="stylesheet"><script src="https://cdn.bootcss.com/uikit/3.2.0/js/uikit.min.js" async></script><script src="https://cdn.bootcss.com/uikit/3.2.0/js/uikit-icons.min.js" async></script><link rel="stylesheet" href="/styles/cold-stone.css"><noscript><p class="text-center">你的浏览器还没开启 Javascript 功能！</p></noscript><meta name="generator" content="Hexo 4.0.0"></head><body><header class="header" uk-sticky="top: 100; animation: uk-animation-slide-top; bottom: #sticky-on-scroll-up"><div class="header-bar"></div><nav class="wrapper header-content"><div class="nav-overlay uk-navbar-left"><h1 class="title nav-list-item uk-logo" data-link="/"><a href="/" data-link="/">冷石</a></h1><ul class="nav-list"><li class="nav-list-item" data-link="/categories/"><a class="nav-list-link" href="/categories">分类</a></li><li class="nav-list-item" data-link="/friends/"><a class="nav-list-link" href="/friends">友链</a></li><li class="nav-list-item" data-link="/about/"><a class="nav-list-link" href="/about/">关于</a></li><li class="nav-list-item" data-link="/rss/"><a class="nav-list-link" href="/atom.xml">RSS</a></li></ul></div><div class="uk-navbar-right translate-x"><a class="uk-navbar-toggle" href="#modal-full" uk-search-icon uk-toggle></a></div></nav></header><div id="modal-full" class="uk-modal-full uk-modal" uk-modal><div class="uk-modal-dialog uk-flex uk-flex-center uk-flex-middle" uk-height-viewport><button class="uk-modal-close-full" type="button" uk-close></button><form class="uk-search uk-search-large search-form" action="//google.com/search" method="get" accept-charset="UTF-8" target="_blank"><input class="uk-search-input search-form-input" type="search" name="q" placeholder="搜索" autofocus autocomplete="false"> <input type="hidden" name="sitesearch" value="https://coldstone.fun"></form></div></div><main class="main wrapper"><article class="article slide-in-right uk-article"><section class="article-header"><h1 class="article-title uk-article-title">Flutter 创建自定义路由过渡动画</h1><p class="article-meta uk-article-meta"><span class="meta-info"><span>最后更新&#58;<time class="post-time" datetime="2020-01-26">2020-01-26</time> </span><span>阅读时间&#58; 7 min</span> <span class="hide" id="busuanzi_container_page_pv">阅读量&#58; <span id="busuanzi_value_page_pv"></span></span></span></p></section><section class="article-content"><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ol><li>使用 <code>PageRouteBuilder</code> 创建自定义路由</li><li>在 <code>transitionsBuilder</code> 方法里创建过渡动画</li><li>过渡动画示例</li><li>定义全局路由过渡动画</li><li>封装自定义路由</li></ol><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在 <code>Flutter</code> 中使用 <code>Navigator.of(context).push(Route route);</code> 方法进行路由跳转时就需要传一个 <code>Route</code> 对象，通常使用 <code>MaterialPageRoute(builder: () {});</code> 创建，使用时会在路由跳转过程中添加默认的过渡动画。当需要自定义路由过渡动画时，就要使用 <code>PageRouteBuilder</code>，它是 <code>Flutter</code> 提供的用来创建自定义的路由的一个类，实例化这个类会得到一个路由对象 <code>Route</code>，要做的就是创建一个自定义的 <code>Route</code>。</p><h2 id="PageRouteBuilder"><a href="#PageRouteBuilder" class="headerlink" title="PageRouteBuilder"></a>PageRouteBuilder</h2><p>使用 <code>PageRouteBuilder</code> 创建自定义路由过渡动画时需要传入两个回调函数作为参数，一个必要参数 <code>pageBuilder</code>，这个函数用来创建跳转的页面，另一个函数 <code>transitionsBuilder</code>，这个函数就是实现过渡动画的地方。</p><blockquote><p><code>transitionsBuilder</code> 的 <code>child</code> 参数是 <code>pageBuilder</code> 函数返回的一个 <code>transitionsBuilder widget</code> 部件， <code>pageBuilder</code> 方法仅会在第一次构建路由的时候被调用，<code>Flutter</code> 能够自动避免做额外的工作，整个过渡期间 <code>child</code> 保存了同一个实例。</p></blockquote><pre><code class="dart">PageRouteBuilder(
  pageBuilder: (
      BuildContext context,
      Animation&lt;double&gt; animation,
      Animation&lt;double&gt; secondaryAnimation,
    ) {
      return widget;
    },
    transitionsBuilder: (
      BuildContext context,
      Animation&lt;double&gt; animation,
      Animation&lt;double&gt; secondaryAnimation,
      Widget child,
    ) {
      return child;
    },
);</code></pre><p>创建自定义路由需要继承 <code>PageRouteBuilder</code>，然后实现自定义路由的构造函数。</p><pre><code class="dart">// 定义
class YourRoute extends PageRouteBuilder {
  final Widget page;

  YourRoute(this.page)
      : super(
          pageBuilder: (
            context,
            animation,
            secondaryAnimation,
          ) {
            return page;
          },
          transitionsBuilder: (
            context,
            animation,
            secondaryAnimation,
            child,
          ) {
            return child;
          },
        );
}

// 使用
Navigator.of(context).push(YourRoute(NewPage()));</code></pre><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>使用 <code>FirstPage</code> 和 <code>SecondPage</code> 两个页面展示效果</p><pre><code class="dart">import &#39;package:flutter/material.dart&#39;;

void main() =&gt; runApp(MyApp());

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      home: FirstPage(),
    );
  }
}

class FirstPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(&#39;First Page&#39;),
        elevation: 0.0,
        backgroundColor: Colors.purple,
      ),
      body: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: &lt;Widget&gt;[
          Center(
            child: RaisedButton(
              onPressed: () {
                Navigator.of(context).push(
                  MaterialPageRoute(builder: (context) =&gt; SecondPage()),
                );
              },
              child: Text(&#39;Next Page&#39;),
            ),
          )
        ],
      ),
      backgroundColor: Colors.purple,
    );
  }
}

class SecondPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(&#39;Second Page&#39;),
        elevation: 0.0,
        backgroundColor: Colors.deepPurpleAccent,
      ),
      body: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: &lt;Widget&gt;[
          Center(
            child: RaisedButton(
              onPressed: () {
                Navigator.pop(context);
              },
              child: Text(&#39;Go Back&#39;),
            ),
          )
        ],
      ),
      backgroundColor: Colors.deepPurpleAccent,
    );
  }
}
</code></pre><h3 id="FadeTransition"><a href="#FadeTransition" class="headerlink" title="FadeTransition"></a><code>FadeTransition</code></h3><pre><code class="dart">class FadeRoute extends PageRouteBuilder {
  final Widget page;

  FadeRoute(this.page)
      : super(
          pageBuilder: (
            context,
            animation,
            secondaryAnimation,
          ) {
            return page;
          },
          transitionsBuilder: (
            context,
            animation,
            secondaryAnimation,
            child,
          ) {
            return FadeTransition(
              opacity: animation,
              child: child,
            );
          },
        );
}</code></pre><div><video src="videos/fade_transition.mov" controls width="320" autoplay muted loop></video></div><h3 id="ScaleTransition"><a href="#ScaleTransition" class="headerlink" title="ScaleTransition"></a><code>ScaleTransition</code></h3><pre><code class="dart">class ScaleRoute extends PageRouteBuilder {
  final Widget page;

  ScaleRoute(this.page)
      : super(
          pageBuilder: (
            context,
            animation,
            secondaryAnimation,
          ) {
            return page;
          },
          transitionsBuilder: (
            context,
            animation,
            secondaryAnimation,
            child,
          ) {
            return ScaleTransition(
              alignment: Alignment.bottomLeft,
              scale: Tween(
                begin: 0.0,
                end: 1.0,
              ).animate(
                CurvedAnimation(
                  parent: animation,
                  curve: Curves.easeInOut,
                ),
              ),
              child: child,
            );
          },
          transitionDuration: Duration(seconds: 1),
        );
}

Navigator.of(context).push(ScaleRoute(SecondPage()));</code></pre><div><video src="videos/scale_transition.mov" controls width="320" autoplay muted loop></video></div><h3 id="RotationTransition"><a href="#RotationTransition" class="headerlink" title="RotationTransition"></a><code>RotationTransition</code></h3><pre><code class="dart">class RotationRoute extends PageRouteBuilder {
  final Widget page;

  RotationRoute(this.page)
      : super(
          pageBuilder: (
            context,
            animation,
            secondaryAnimation,
          ) {
            return page;
          },
          transitionsBuilder: (
            context,
            animation,
            secondaryAnimation,
            child,
          ) {
            Animation myAnimation = CurvedAnimation(
              parent: animation,
              curve: Curves.easeInBack,
            );

            return RotationTransition(
              turns: myAnimation,
              child: child,
            );
          },
          transitionDuration: Duration(seconds: 1),
        );
}

Navigator.of(context).push(RotationRoute(SecondPage()));</code></pre><div><video src="videos/rotation_transition.mov" controls width="320" autoplay muted loop></video></div><h3 id="ScaleRotationRoute"><a href="#ScaleRotationRoute" class="headerlink" title="ScaleRotationRoute"></a><code>ScaleRotationRoute</code></h3><p>结合两个过渡动画</p><pre><code class="dart">class ScaleRotationRoute extends PageRouteBuilder {
  final Widget page;

  ScaleRotationRoute(this.page)
      : super(
          pageBuilder: (
            context,
            animation,
            secondaryAnimation,
          ) {
            return page;
          },
          transitionsBuilder: (
            context,
            animation,
            secondaryAnimation,
            child,
          ) {
            return ScaleTransition(
              scale: animation,
              child: RotationTransition(
                turns: Tween(
                  begin: 0.0,
                  end: 1.0,
                ).animate(
                  CurvedAnimation(parent: animation, curve: Curves.linear),
                ),
                child: child,
              ),
            );
          },
          transitionDuration: Duration(milliseconds: 800),
        );
}

Navigator.of(context).push(ScaleRotationRoute(SecondPage()));</code></pre><div><video src="videos/scale_rotation_transition.mov" controls width="320" autoplay muted loop></video></div><h3 id="TransformRoute"><a href="#TransformRoute" class="headerlink" title="TransformRoute"></a><code>TransformRoute</code></h3><p>使用 <code>Transform</code> 部件创造 <code>3D</code> 效果</p><pre><code class="dart">import &#39;dart:math&#39; show pi;

class TransformRoute extends PageRouteBuilder {
  final Widget page;

  TransformRoute(this.page)
      : super(
          pageBuilder: (
            context,
            animation,
            secondaryAnimation,
          ) {
            return page;
          },
          transitionsBuilder: (
            context,
            animation,
            secondaryAnimation,
            child,
          ) {
            return Transform(
              transform: Matrix4.identity()
                // 类似于 CSS 里面 `perspective` 属性，确定 z=0 平面与用户之间的距离
                ..setEntry(3, 2, 0.0001)
                ..rotateX(animation.value * pi * 2)
                ..rotateY(animation.value * pi * 2),
              alignment: FractionalOffset.center,
              child: child,
            );
          },
          transitionDuration: Duration(seconds: 2),
        );
}

Navigator.of(context).push(TransformRoute(SecondPage()));</code></pre><div><video src="videos/transform_transition.mov" controls width="320" autoplay muted loop></video></div><h3 id="EnterExitRoute"><a href="#EnterExitRoute" class="headerlink" title="EnterExitRoute"></a><code>EnterExitRoute</code></h3><p>同时为进入页面和退出页面添加动画</p><pre><code class="dart">class EnterExitRoute extends PageRouteBuilder {
  final Widget enterPage;
  final Widget exitPage;

  EnterExitRoute(this.enterPage, this.exitPage)
      : super(
          pageBuilder: (
            context,
            animation,
            secondaryAnimation,
          ) {
            return exitPage;
          },
          transitionsBuilder: (
            context,
            animation,
            secondaryAnimation,
            child,
          ) =&gt;
              Stack(
            children: [
              SlideTransition(
                position: Tween&lt;Offset&gt;(
                  begin: Offset(0.0, 0.0),
                  end: Offset(-1.0, 0.0),
                ).animate(
                  CurvedAnimation(parent: animation, curve: Curves.easeIn),
                ),
                child: enterPage,
              ),
              SlideTransition(
                position: Tween&lt;Offset&gt;(
                  begin: Offset(1.0, 0.0),
                  end: Offset.zero,
                ).animate(
                  CurvedAnimation(parent: animation, curve: Curves.easeInOut),
                ),
                child: exitPage,
              )
            ],
          ),
        );
}

Navigator.of(context).push(
  EnterExitRoute(FirstPage(), SecondPage()),
);</code></pre><div><video src="videos/enter_exist_transition.mov" controls width="320" autoplay muted loop></video></div><h2 id="使用-Navigator-pushNamed-方法跳转"><a href="#使用-Navigator-pushNamed-方法跳转" class="headerlink" title="使用 Navigator.pushNamed 方法跳转"></a>使用 <code>Navigator.pushNamed</code> 方法跳转</h2><p>在 <code>onGenerateRoute</code> 对跳转路由的 <code>name</code> 进行判断，对特定的路由添加过渡动画。</p><pre><code class="dart">class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      home: FirstPage(),
      onGenerateRoute: (settings) {
        switch (settings.name) {
          case &#39;/second&#39;:
            return ScaleRoute(SecondPage());
            break;
          default:
            return null;
        }
      },
    );
  }
}

Navigator.pushNamed(context, &#39;/second&#39;, arguments: {});</code></pre><h2 id="设置全局的路由过渡动画"><a href="#设置全局的路由过渡动画" class="headerlink" title="设置全局的路由过渡动画"></a>设置全局的路由过渡动画</h2><p><code>Flutter</code> 的默认路由过渡动画是由 <code>buildTransitions</code> 方法创建的，它使用的是 <code>Theme.of(context).pageTransitionsTheme</code>方法，因此可以定义全局的路由跳转过渡动画。</p><pre><code class="dart">@override
Widget buildTransitions(context, animation, secondaryAnimation, child) {
    final PageTransitionsTheme theme = Theme.of(context).pageTransitionsTheme;
    return theme.buildTransitions&lt;T&gt;(this, context, animation, secondaryAnimation, child);
}</code></pre><p>首先自定义一个 <code>TransitionBuilder</code>， <code>buildTransitions</code> 方法返回跳转页面。然后配置 <code>theme</code> 的 <code>pageTransitionsTheme</code>，设置对应的平台，最后在使用 <code>MaterialPageRoute</code> 或者 <code>CupertinoPageRoute</code> 进行页面跳转时就会有自定义的过渡动画了。</p><pre><code class="dart">class ScaleTransitionBuilder extends PageTransitionsBuilder {
  @override
  Widget buildTransitions&lt;T&gt;(
    route,
    context,
    animation,
    secondaryAnimation,
    child,
  ) {
    return ScaleTransition(
      scale: CurvedAnimation(parent: animation, curve: Curves.easeIn),
      child: child,
    );
  }
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      home: FirstPage(),
      theme: ThemeData(
        pageTransitionsTheme: PageTransitionsTheme(
          builders: {
            TargetPlatform.android: ScaleTransitionBuilder(),
            TargetPlatform.iOS: ScaleTransitionBuilder(),
          },
        ),
      ),
    );
  }
}

Navigator.push(context, MaterialPageRoute(builder: (ctx) =&gt; SecondPage()));</code></pre><h2 id="将动画封装成一个库"><a href="#将动画封装成一个库" class="headerlink" title="将动画封装成一个库"></a>将动画封装成一个库</h2><p>将自定义的路由过渡动画封装起来方便使用。</p><pre><code class="dart">enum TransitionType {
  fade,
  scale,
  rotate,
  transform,
}

class PageTransition extends PageRouteBuilder {
  PageTransition(TransitionType type, Widget page, Duration time)
      : super(
          pageBuilder: (
            context,
            animation,
            secondaryAnimation,
          ) {
            return page;
          },
          transitionsBuilder: (
            context,
            animation,
            secondaryAnimation,
            child,
          ) {
            switch (type) {
              case TransitionType.fade:
                return FadeTransition(opacity: animation, child: child);
                break;
              case TransitionType.scale:
                return ScaleTransition(
                  scale: Tween(begin: 0.0, end: 1.0).animate(
                    CurvedAnimation(parent: animation, curve: Curves.easeInOut),
                  ),
                  child: child,
                );
                break;
              case TransitionType.rotate:
                return RotationTransition(
                  turns: CurvedAnimation(
                    parent: animation,
                    curve: Curves.easeInBack,
                  ),
                  child: child,
                );
                break;
              case TransitionType.transform:
                return Transform(
                  transform: Matrix4.identity()
                    ..setEntry(3, 2, 0.0001)
                    ..rotateX(animation.value * pi * 2)
                    ..rotateY(animation.value * pi * 2),
                  alignment: FractionalOffset.center,
                  child: child,
                );
                break;
              default:
                return child;
            };
          },
          transitionDuration: time,
        );
}

// 使用
Navigator.push(
  context,
  PageTransition(
    TransitionType.rotate,
    SecondPage(),
    Duration(milliseconds: 800),
  ),
}</code></pre><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://flutter.cn/docs/cookbook/animation/page-route-animation" target="_blank" rel="noopener">为页面切换加入动画效果</a></p><p><a href="https://medium.com/flutter-community/everything-you-need-to-know-about-flutter-page-route-transition-9ef5c1b32823" target="_blank" rel="noopener">Everything you need to know about Flutter page route transition</a></p><p><a href="https://medium.com/flutter/perspective-on-flutter-6f832f4d912e" target="_blank" rel="noopener">Perspective on Flutter</a></p></section></article><section class="prev-next card slide-in-right"><a href="/post/2020/01/26/flutter-show-search/" class="link prev" title="在 Flutter 应用中实现搜索"><span class="hover-underline-animation">&larr; 在 Flutter 应用中实现搜索</span> </a><a href="/post/2019/12/05/egg-api-dev/" class="link next" title="Egg.js 上传接口开发总结"><span class="hover-underline-animation">Egg.js 上传接口开发总结 &rarr;</span></a></section><section class="article-toc"><div class="card uk-margin-remove-bottom"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#TL-DR"><span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PageRouteBuilder"><span class="toc-text">PageRouteBuilder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例"><span class="toc-text">示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FadeTransition"><span class="toc-text">FadeTransition</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ScaleTransition"><span class="toc-text">ScaleTransition</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RotationTransition"><span class="toc-text">RotationTransition</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ScaleRotationRoute"><span class="toc-text">ScaleRotationRoute</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TransformRoute"><span class="toc-text">TransformRoute</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EnterExitRoute"><span class="toc-text">EnterExitRoute</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-Navigator-pushNamed-方法跳转"><span class="toc-text">使用 Navigator.pushNamed 方法跳转</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#设置全局的路由过渡动画"><span class="toc-text">设置全局的路由过渡动画</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#将动画封装成一个库"><span class="toc-text">将动画封装成一个库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文章"><span class="toc-text">参考文章</span></a></li></ol></div></section><section class="article slide-in-right"><div class="loader" id="loader"><svg viewBox="0 0 50 50"><circle class="ring" cx="25" cy="25" r="20"></circle><circle class="ball" cx="25" cy="5" r="3.5"></circle></svg></div><div class="comment" id="utteranc"></div><noscript>Please activate JavaScript for normal use of comments</noscript></section><a class="card back-to-top" id="backTop">&UpArrow;</a></main><script>window.COLD_STONE={root:"/",author:"Cold Stone",gaid:"UA-119658292-2",repo:"xrr2016/blog"}</script><script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script><script>hljs.initHighlightingOnLoad()</script><script src="/scripts/busuanzi.js" referrerpolicy="origin"></script><script src="/scripts/cold-stone.js"></script><script src="//www.googletagmanager.com/gtag/js?id=UA-119658292-2"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config",window.COLD_STONE.gaid)</script></body></html>