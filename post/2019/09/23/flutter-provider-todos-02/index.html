<!DOCTYPE html>
<html lang="zh">
  <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="referrer" content="no-referrer">
    <meta name="theme-color" content="#333333">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="google" content="notranslate">
    <meta name="format-detection" content="telephone=no">
    <meta name="keyword" content="Web, Js, CSS, Node.js, Frontend, Flutter, Docker">
    <meta name="description" content="想写什么就写什么">
    <title>使用 Provider 管理 Flutter 应用状态 (下) - 冷石的博客</title>
    <base href="/">
    <link rel="preconnect" href="//cdnjs.cloudflare.com">
    <link rel="manifest" href="/manifest.json">
    <link rel="shortcut icon" href="/icons/icon-72x72.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/styles/atom-one-light.min.css">
    <link rel="stylesheet" href="/styles/sanitize.css">
<link rel="stylesheet" href="/styles/cold-stone.css">
    <noscript>
      <p class="text-center">你的浏览器还没开启 Javascript 功能！</p>
    </noscript>
</head>

  <body>
    

    

    <main class="main wrapper"><article class="article slide-in-right">
  <section>
    <h1 class="article-title">
      使用 Provider 管理 Flutter 应用状态 (下)
    </h1>
    <p class="article-meta">
      <span class="meta-info">
        <span>
          最后更新&#58; 2019-10-05 03:33:25
        </span>
        <span>字数&#58; 2.2k</span>
        <span>阅读时间&#58; 11 min</span>
      </span>
      <a  class="meta-link" href="/">返回</a>
    </p>
  </section>
  <section><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>紧接上篇，对于一个代办事项的新增，修改，删除功能都已经完成了，但是数据都是保存在内存中的，重新启动应用数据就重置了，为了存储数据可以将数据存到手机的存储里面或者存到远程服务器上，本文就实现如何使用 <a href="https://github.com/flutterchina/dio" target="_blank" rel="noopener">dio</a> 将数据存到服务器</p>
<p><a href="https://github.com/xrr2016/flutter_provider_todos/tree/http" target="_blank" rel="noopener">源码地址</a></p>
<h2 id="开发准备"><a href="#开发准备" class="headerlink" title="开发准备"></a>开发准备</h2><p>在 <code>pubspec.yaml</code> 添加 dio 依赖；一个存储数据的服务，我用的是 <a href="https://jsonbox.io/" target="_blank" rel="noopener">jsonbox</a></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line"><span class="attr">  dio:</span> <span class="string">^3.0.1</span></span><br></pre></td></tr></table></figure>

<h2 id="配置-dio"><a href="#配置-dio" class="headerlink" title="配置 dio"></a>配置 dio</h2><p>由于这个应用只有一个服务地址，所以创建一个 dio 的单例来进行请求就很好了，新建一个 request.dart 文件配置 dio，使用一个函数返回创建的 dio 实例</p>
<ul>
<li>设置基础的请求地址</li>
<li>设置请求超时时间</li>
<li>设置在调试控制台输出请求响应体方便查看请求</li>
</ul>
<p>基本设置下就可以用了，其它设置可以查看 dio 的<a href="https://pub.flutter-io.cn/packages/dio" target="_blank" rel="noopener">文档</a></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:dio/dio.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> DB_URL = <span class="string">'https://jsonbox.io/box_7ea9df49e805cf99509b'</span>;</span><br><span class="line"></span><br><span class="line">Dio craeteDio() &#123;</span><br><span class="line">  BaseOptions options = BaseOptions(</span><br><span class="line">    baseUrl: DB_URL,</span><br><span class="line">    connectTimeout: <span class="number">5000</span>,</span><br><span class="line">    receiveTimeout: <span class="number">3000</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  Dio dio = Dio(options);</span><br><span class="line"></span><br><span class="line">  dio.interceptors.add(LogInterceptor(</span><br><span class="line">    error: <span class="keyword">true</span>,</span><br><span class="line">    request: <span class="keyword">false</span>,</span><br><span class="line">    responseBody: <span class="keyword">true</span>,</span><br><span class="line">    responseHeader: <span class="keyword">false</span>,</span><br><span class="line">    requestHeader: <span class="keyword">false</span>,</span><br><span class="line">  ));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> dio;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="修改-Todo-模型"><a href="#修改-Todo-模型" class="headerlink" title="修改 Todo 模型"></a>修改 Todo 模型</h2><p>由于需要从服务器上获取 todo 数据，服务返回的数据是 json 格式，所以需要在拿到数据的时候将单个 todo 的 json 数据转成 Todo 实例，新建一个 model/todo.dart 文件，比之前多的是两个方法而已，<code>fromJson</code> 这个工厂函数作用是使用 json 数据实例化一个 Todo，<code>toJson</code> 方法用来将一个 Todo 转成一个 Map 结构的数据</p>
<p>如果一个模型的字段较少可以手写，但是当字段较多比较复杂的时候就需要使用工具来帮助生成代码了，我使用的是 <a href="https://app.quicktype.io/" target="_blank" rel="noopener">quicktype</a> 这个工具</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Todo</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String</span> id;</span><br><span class="line">  <span class="built_in">bool</span> finish;</span><br><span class="line">  <span class="built_in">String</span> thing;</span><br><span class="line"></span><br><span class="line">  Todo(&#123;</span><br><span class="line">    <span class="keyword">this</span>.id,</span><br><span class="line">    <span class="keyword">this</span>.thing,</span><br><span class="line">    <span class="keyword">this</span>.finish,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">factory</span> Todo.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; json) =&gt; Todo(</span><br><span class="line">        id: json[<span class="string">"_id"</span>].toString(),</span><br><span class="line">        thing: json[<span class="string">"thing"</span>],</span><br><span class="line">        finish: json[<span class="string">"finish"</span>],</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; toJson() =&gt; &#123;</span><br><span class="line">        <span class="string">"id"</span>: id,</span><br><span class="line">        <span class="string">"thing"</span>: thing,</span><br><span class="line">        <span class="string">"finish"</span>: finish,</span><br><span class="line">      &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="发送请求"><a href="#发送请求" class="headerlink" title="发送请求"></a>发送请求</h2><p>配置好 dio 就可以在 todos.dart 向服务器发送请求了，修改 store/todos.dart，给 Todos 类添加了一个 _dio 属性用来发送请求，一个 getTodos 方法用来获取全部 todo 的列表数据，然后修改 addTodo，removeTodo，editTodo 方法使用 _dio 向服务器发送 post，delete，put 请求。</p>
<p>需要注意的一点是将 json 转换成实例的问题，很容易就会出现类似</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type <span class="string">'List&lt;dynamic&gt;'</span> <span class="keyword">is</span> not a subtype of type <span class="string">'List&lt;Todo&gt;'</span></span><br></pre></td></tr></table></figure>

<p>这种错误，这种都是类型转换的问题，我看了一篇文章后才算弄懂了一点 <a href="https://medium.com/flutter-community/parsing-complex-json-in-flutter-747c46655f51" target="_blank" rel="noopener">parsing-complex-json-in-flutter</a></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:dio/dio.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/foundation.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../request.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'../model/todo.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Todos</span> <span class="keyword">extends</span> <span class="title">ChangeNotifier</span> </span>&#123;</span><br><span class="line">  <span class="built_in">List</span>&lt;Todo&gt; _items = [];</span><br><span class="line"></span><br><span class="line">  Dio _dio = craeteDio();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> items &#123;</span><br><span class="line">    <span class="keyword">return</span> [..._items];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> refresh() &#123;</span><br><span class="line">    notifyListeners();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">List</span>&gt; getTodos() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Response response = <span class="keyword">await</span> _dio.<span class="keyword">get</span>(<span class="string">'/todos'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> list = response.data <span class="keyword">as</span> <span class="built_in">List</span>;</span><br><span class="line">      _items = <span class="built_in">List</span>&lt;Todo&gt;.from(list.map((i) =&gt; Todo.fromJson(i)).toList());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> items;</span><br><span class="line">    &#125; on DioError <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future addTodo(<span class="built_in">String</span> thing) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Response response = <span class="keyword">await</span> _dio.post(<span class="string">'/todos'</span>, data: &#123;</span><br><span class="line">        <span class="string">"thing"</span>: thing,</span><br><span class="line">        <span class="string">"finish"</span>: <span class="keyword">false</span>,</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      Todo todo = Todo(</span><br><span class="line">        thing: thing,</span><br><span class="line">        id: response.data[<span class="string">"_id"</span>],</span><br><span class="line">        finish: response.data[<span class="string">"finish"</span>],</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      _items.insert(<span class="number">0</span>, todo);</span><br><span class="line">      refresh();</span><br><span class="line">    &#125; on DioError <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future removeTodo(<span class="built_in">int</span> index) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="built_in">String</span> todoId = _items[index].id;</span><br><span class="line">      <span class="keyword">await</span> _dio.delete(<span class="string">"/todos/<span class="subst">$todoId</span>"</span>);</span><br><span class="line">      _items.removeAt(index);</span><br><span class="line">      refresh();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future editTodo(<span class="built_in">int</span> index, <span class="built_in">String</span> thing, <span class="built_in">bool</span> finish) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="built_in">String</span> todoId = _items[index].id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> _dio.put(<span class="string">"/todos/<span class="subst">$todoId</span>"</span>, data: &#123;</span><br><span class="line">        <span class="string">"thing"</span>: thing,</span><br><span class="line">        <span class="string">"finish"</span>: finish,</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      Todo todo = _items[index];</span><br><span class="line">      todo.thing = thing;</span><br><span class="line">      todo.finish = finish;</span><br><span class="line">      refresh();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> toggleFinish(<span class="built_in">int</span> index) &#123;</span><br><span class="line">    <span class="keyword">final</span> todo = _items[index];</span><br><span class="line">    todo.finish = !todo.finish;</span><br><span class="line"></span><br><span class="line">    refresh();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> isTodoExist(<span class="built_in">String</span> thing) &#123;</span><br><span class="line">    <span class="built_in">bool</span> isExist = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; _items.length; i++) &#123;</span><br><span class="line">      <span class="keyword">final</span> todo = _items[i];</span><br><span class="line">      <span class="keyword">if</span> (todo.thing == thing) &#123;</span><br><span class="line">        isExist = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> isExist;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用数据"><a href="#使用数据" class="headerlink" title="使用数据"></a>使用数据</h2><p>有了数据后就可以在列表页使用了，由于现在数据是从服务器返回的，会有请求耗时，所以需要使用 <code>FutureBuilder</code> 这个部件渲染列表，<code>FutureBuilder</code> 需要一个设置一个 future 来判断状态，这里自然是 Todos 类的 <code>getTodos</code> 方法返回的 Future 对象，然后 builder 就是一个函数，有两个参数，一个是 context 上下文对象，一个是 snapshot 对象，表示的是这个 future 的状态。</p>
<p>在 builder 方法里面用一个 switch 语句判断这个 future 的状态，根据状态返回需要渲染的部件，有以下几种状态 none（状态不存在），active（运行中），waiting（等待中），done（完成），如果都不匹配就，返回一个 null 值。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:provider/provider.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'store/todos.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'widget/add_todo_button.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'widget/edit_todo_button.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'widget/remove_todo_button.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TodosPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: Text(<span class="string">'Flutter Provider Todos'</span>)),</span><br><span class="line">      body: FutureBuilder(</span><br><span class="line">        future: Provider.of&lt;Todos&gt;(context).getTodos(),</span><br><span class="line">        builder: (context, snapshot) &#123;</span><br><span class="line">          <span class="keyword">switch</span> (snapshot.connectionState) &#123;</span><br><span class="line">            <span class="keyword">case</span> ConnectionState.none:</span><br><span class="line">              <span class="keyword">return</span> Text(<span class="string">'Press button to start.'</span>);</span><br><span class="line">            <span class="keyword">case</span> ConnectionState.active:</span><br><span class="line">            <span class="keyword">case</span> ConnectionState.waiting:</span><br><span class="line">              <span class="keyword">return</span> Center(child: CircularProgressIndicator());</span><br><span class="line">            <span class="keyword">case</span> ConnectionState.done:</span><br><span class="line">              <span class="keyword">if</span> (snapshot.hasError) &#123;</span><br><span class="line">                <span class="built_in">print</span>(snapshot.error);</span><br><span class="line">                <span class="keyword">return</span> Center(</span><br><span class="line">                  child: Text(</span><br><span class="line">                    <span class="string">'出错了，请重试'</span>,</span><br><span class="line">                    style: TextStyle(fontSize: <span class="number">18.0</span>, color: Colors.red),</span><br><span class="line">                  ),</span><br><span class="line">                );</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="built_in">List</span> items = snapshot.data;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (items == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> Center(</span><br><span class="line">                  child: Text(</span><br><span class="line">                    <span class="string">'还没有代办事项，快去添加吧'</span>,</span><br><span class="line">                    style: TextStyle(fontSize: <span class="number">18.0</span>),</span><br><span class="line">                  ),</span><br><span class="line">                );</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">return</span> ListView.builder(</span><br><span class="line">                  itemCount: items.length,</span><br><span class="line">                  itemBuilder: (_, index) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Column(</span><br><span class="line">                      children: &lt;Widget&gt;[</span><br><span class="line">                        ListTile(</span><br><span class="line">                          title: Text(</span><br><span class="line">                            items[index].thing,</span><br><span class="line">                            style: TextStyle(</span><br><span class="line">                              color: items[index].finish</span><br><span class="line">                                  ? Colors.green</span><br><span class="line">                                  : Colors.grey,</span><br><span class="line">                            ),</span><br><span class="line">                          ),</span><br><span class="line">                          trailing: Container(</span><br><span class="line">                            width: <span class="number">150</span>,</span><br><span class="line">                            child: Row(</span><br><span class="line">                              mainAxisAlignment: MainAxisAlignment.end,</span><br><span class="line">                              children: &lt;Widget&gt;[</span><br><span class="line">                                EditTodoButton(todoIndex: index),</span><br><span class="line">                                RemoveTodoButton(todoIndex: index),</span><br><span class="line">                              ],</span><br><span class="line">                            ),</span><br><span class="line">                          ),</span><br><span class="line">                        ),</span><br><span class="line">                        Divider(),</span><br><span class="line">                      ],</span><br><span class="line">                    );</span><br><span class="line">                  &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">      ),</span><br><span class="line">      floatingActionButton: Consumer&lt;Todos&gt;(</span><br><span class="line">        builder: (_, todos, child) &#123;</span><br><span class="line">          <span class="keyword">return</span> AddTodoButton();</span><br><span class="line">        &#125;,</span><br><span class="line">      ),</span><br><span class="line">      floatingActionButtonLocation: FloatingActionButtonLocation.centerFloat,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="修改按钮"><a href="#修改按钮" class="headerlink" title="修改按钮"></a>修改按钮</h2><p>接下来就是需要修改新增，编辑，删除代办的按钮了，同理由于现在需要跟服务端进行通信，所以需要根据请求状态来处理逻辑，主要的修改就是使用 <code>async/await</code> 语法等到一个请求完成后，根据返回值进行处理。</p>
<p>添加 Todo 按钮</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:provider/provider.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../store/todos.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddTodoButton</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _AddTodoButtonState createState() =&gt; _AddTodoButtonState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_AddTodoButtonState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">AddTodoButton</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> _formKey = GlobalKey&lt;FormState&gt;();</span><br><span class="line">  <span class="keyword">final</span> _controller = TextEditingController();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    _formKey.currentState.dispose();</span><br><span class="line">    _controller.dispose();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Consumer&lt;Todos&gt;(</span><br><span class="line">      builder: (_, todos, child) &#123;</span><br><span class="line">        _addTodo() <span class="keyword">async</span> &#123;</span><br><span class="line">          <span class="keyword">final</span> isValid = _formKey.currentState.validate();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!isValid) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">final</span> thing = _controller.value.text;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> todos.addTodo(thing);</span><br><span class="line">            Navigator.pop(context);</span><br><span class="line">            _controller.clear();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            Scaffold.of(context).showSnackBar(</span><br><span class="line">              SnackBar(content: Text(<span class="string">'新增代办失败了，请重试。'</span>)),</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> FloatingActionButton(</span><br><span class="line">          child: Icon(Icons.add),</span><br><span class="line">          onPressed: () &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">'add todo'</span>);</span><br><span class="line">            <span class="keyword">return</span> showDialog(</span><br><span class="line">              context: context,</span><br><span class="line">              builder: (BuildContext _) &#123;</span><br><span class="line">                <span class="keyword">return</span> SimpleDialog(</span><br><span class="line">                  title: Text(<span class="string">'添加 Todo'</span>),</span><br><span class="line">                  contentPadding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">24.0</span>),</span><br><span class="line">                  children: &lt;Widget&gt;[</span><br><span class="line">                    Form(</span><br><span class="line">                      key: _formKey,</span><br><span class="line">                      child: Column(</span><br><span class="line">                        children: &lt;Widget&gt;[</span><br><span class="line">                          TextFormField(</span><br><span class="line">                            autofocus: <span class="keyword">true</span>,</span><br><span class="line">                            autovalidate: <span class="keyword">false</span>,</span><br><span class="line">                            controller: _controller,</span><br><span class="line">                            keyboardType: TextInputType.text,</span><br><span class="line">                            decoration: InputDecoration(</span><br><span class="line">                              border: OutlineInputBorder(),</span><br><span class="line">                              labelText: <span class="string">'输入你想做的事'</span>,</span><br><span class="line">                            ),</span><br><span class="line">                            validator: (val) &#123;</span><br><span class="line">                              <span class="keyword">if</span> (val.isEmpty) &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="string">'想做的事不能为空'</span>;</span><br><span class="line">                              &#125;</span><br><span class="line"></span><br><span class="line">                              <span class="built_in">bool</span> isExist = todos.isTodoExist(val);</span><br><span class="line"></span><br><span class="line">                              <span class="keyword">if</span> (isExist) &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="string">'这件事情已经存在了'</span>;</span><br><span class="line">                              &#125;</span><br><span class="line">                              <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                            &#125;,</span><br><span class="line">                          ),</span><br><span class="line">                          SizedBox(height: <span class="number">20</span>),</span><br><span class="line">                          Row(</span><br><span class="line">                            mainAxisAlignment: MainAxisAlignment.end,</span><br><span class="line">                            children: &lt;Widget&gt;[</span><br><span class="line">                              FlatButton(</span><br><span class="line">                                child: Text(<span class="string">'取消'</span>),</span><br><span class="line">                                onPressed: () &#123;</span><br><span class="line">                                  Navigator.pop(context);</span><br><span class="line">                                &#125;,</span><br><span class="line">                              ),</span><br><span class="line">                              RaisedButton(</span><br><span class="line">                                child: Text(</span><br><span class="line">                                  <span class="string">'确定'</span>,</span><br><span class="line">                                  style: TextStyle(color: Colors.white),</span><br><span class="line">                                ),</span><br><span class="line">                                color: Theme.of(context).primaryColor,</span><br><span class="line">                                onPressed: _addTodo,</span><br><span class="line">                              ),</span><br><span class="line">                            ],</span><br><span class="line">                          ),</span><br><span class="line">                        ],</span><br><span class="line">                      ),</span><br><span class="line">                    ),</span><br><span class="line">                  ],</span><br><span class="line">                );</span><br><span class="line">              &#125;,</span><br><span class="line">            );</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编辑 Todo 按钮</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:provider/provider.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../model/todo.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'../store/todos.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EditTodoButton</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> todoIndex;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> EditTodoButton(&#123;Key key, <span class="keyword">this</span>.todoIndex&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _EditTodoButtonState createState() =&gt; _EditTodoButtonState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_EditTodoButtonState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">EditTodoButton</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> _formKey = GlobalKey&lt;FormState&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    _formKey?.currentState?.dispose();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Consumer&lt;Todos&gt;(</span><br><span class="line">      builder: (context, todos, child) &#123;</span><br><span class="line">        <span class="keyword">final</span> todoIndex = widget.todoIndex;</span><br><span class="line">        <span class="keyword">final</span> Todo todo = todos.items[todoIndex];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> IconButton(</span><br><span class="line">          color: Colors.blue,</span><br><span class="line">          icon: Icon(Icons.edit),</span><br><span class="line">          onPressed: () &#123;</span><br><span class="line">            <span class="keyword">return</span> showDialog(</span><br><span class="line">              context: context,</span><br><span class="line">              builder: (_) &#123;</span><br><span class="line">                <span class="keyword">return</span> SimpleDialog(</span><br><span class="line">                  title: Text(<span class="string">'编辑 Todo'</span>),</span><br><span class="line">                  contentPadding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">24.0</span>),</span><br><span class="line">                  children: &lt;Widget&gt;[</span><br><span class="line">                    Form(</span><br><span class="line">                      key: _formKey,</span><br><span class="line">                      child: Column(</span><br><span class="line">                        children: &lt;Widget&gt;[</span><br><span class="line">                          TextFormField(</span><br><span class="line">                            autofocus: <span class="keyword">false</span>,</span><br><span class="line">                            autovalidate: <span class="keyword">false</span>,</span><br><span class="line">                            initialValue: todo.thing,</span><br><span class="line">                            decoration: InputDecoration(</span><br><span class="line">                              border: OutlineInputBorder(),</span><br><span class="line">                              labelText: <span class="string">'输入你想做的事'</span>,</span><br><span class="line">                            ),</span><br><span class="line">                            onChanged: (val) &#123;</span><br><span class="line">                              todo.thing = val;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            validator: (val) &#123;</span><br><span class="line">                              <span class="keyword">if</span> (val.isEmpty) &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="string">'想做的事不能为空'</span>;</span><br><span class="line">                              &#125;</span><br><span class="line">                              <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                            &#125;,</span><br><span class="line">                          ),</span><br><span class="line">                          SizedBox(height: <span class="number">20</span>),</span><br><span class="line">                          SwitchListTile(</span><br><span class="line">                            title: <span class="keyword">const</span> Text(<span class="string">'是否完成'</span>),</span><br><span class="line">                            value: todo.finish,</span><br><span class="line">                            onChanged: (<span class="built_in">bool</span> value) &#123;</span><br><span class="line">                              todo.finish = value;</span><br><span class="line">                            &#125;,</span><br><span class="line">                          ),</span><br><span class="line">                          SizedBox(height: <span class="number">20</span>),</span><br><span class="line">                          Row(</span><br><span class="line">                            mainAxisAlignment: MainAxisAlignment.end,</span><br><span class="line">                            children: &lt;Widget&gt;[</span><br><span class="line">                              FlatButton(</span><br><span class="line">                                child: Text(<span class="string">'取消'</span>),</span><br><span class="line">                                onPressed: () =&gt; Navigator.pop(context),</span><br><span class="line">                              ),</span><br><span class="line">                              RaisedButton(</span><br><span class="line">                                child: Text(</span><br><span class="line">                                  <span class="string">'确定'</span>,</span><br><span class="line">                                  style: TextStyle(color: Colors.white),</span><br><span class="line">                                ),</span><br><span class="line">                                color: Theme.of(context).primaryColor,</span><br><span class="line">                                onPressed: () <span class="keyword">async</span> &#123;</span><br><span class="line">                                  <span class="keyword">final</span> isValid =</span><br><span class="line">                                      _formKey.currentState.validate();</span><br><span class="line"></span><br><span class="line">                                  <span class="keyword">if</span> (!isValid) &#123;</span><br><span class="line">                                    <span class="keyword">return</span>;</span><br><span class="line">                                  &#125;</span><br><span class="line"></span><br><span class="line">                                  <span class="keyword">try</span> &#123;</span><br><span class="line">                                    <span class="keyword">await</span> todos.editTodo(</span><br><span class="line">                                      todoIndex,</span><br><span class="line">                                      todo.thing,</span><br><span class="line">                                      todo.finish,</span><br><span class="line">                                    );</span><br><span class="line">                                    Navigator.pop(context);</span><br><span class="line">                                  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                                    Scaffold.of(context).showSnackBar(</span><br><span class="line">                                      SnackBar(content: Text(<span class="string">'修改代办失败了，请重试。'</span>)),</span><br><span class="line">                                    );</span><br><span class="line">                                  &#125;</span><br><span class="line">                                &#125;,</span><br><span class="line">                              )</span><br><span class="line">                            ],</span><br><span class="line">                          ),</span><br><span class="line">                        ],</span><br><span class="line">                      ),</span><br><span class="line">                    ),</span><br><span class="line">                  ],</span><br><span class="line">                );</span><br><span class="line">              &#125;,</span><br><span class="line">            );</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除 Todo 按钮</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:provider/provider.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../model/todo.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'../store/todos.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RemoveTodoButton</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> todoIndex;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> RemoveTodoButton(&#123;Key key, <span class="keyword">this</span>.todoIndex&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Consumer&lt;Todos&gt;(builder: (_, todos, child) &#123;</span><br><span class="line">      <span class="keyword">final</span> Todo todo = todos.items[todoIndex];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> IconButton(</span><br><span class="line">        color: Colors.red,</span><br><span class="line">        icon: Icon(Icons.delete),</span><br><span class="line">        onPressed: () &#123;</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">'delete todo'</span>);</span><br><span class="line">          showDialog(</span><br><span class="line">            context: context,</span><br><span class="line">            builder: (BuildContext context) &#123;</span><br><span class="line">              <span class="keyword">return</span> AlertDialog(</span><br><span class="line">                title: Text(<span class="string">'确认删除 <span class="subst">$&#123;todo.thing&#125;</span>?'</span>),</span><br><span class="line">                actions: &lt;Widget&gt;[</span><br><span class="line">                  FlatButton(</span><br><span class="line">                    child: Text(</span><br><span class="line">                      <span class="string">'取消'</span>,</span><br><span class="line">                      style: TextStyle(color: Colors.grey),</span><br><span class="line">                    ),</span><br><span class="line">                    onPressed: () =&gt; Navigator.pop(context),</span><br><span class="line">                  ),</span><br><span class="line">                  FlatButton(</span><br><span class="line">                    child: Text(<span class="string">'确认'</span>),</span><br><span class="line">                    onPressed: () <span class="keyword">async</span> &#123;</span><br><span class="line">                      <span class="keyword">await</span> todos.removeTodo(todoIndex);</span><br><span class="line">                      Navigator.pop(context);</span><br><span class="line">                    &#125;,</span><br><span class="line">                  ),</span><br><span class="line">                ],</span><br><span class="line">              );</span><br><span class="line">            &#125;,</span><br><span class="line">          );</span><br><span class="line">        &#125;,</span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>至此所有的数据都存储在服务器上了，重启应用数据也会从服务器上获取了。</p></section>
</article>

<section class="card article-toc">
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开发准备"><span class="toc-text">开发准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置-dio"><span class="toc-text">配置 dio</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改-Todo-模型"><span class="toc-text">修改 Todo 模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#发送请求"><span class="toc-text">发送请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用数据"><span class="toc-text">使用数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改按钮"><span class="toc-text">修改按钮</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结语"><span class="toc-text">结语</span></a></li></ol>
</section>

<section class="article slide-in-right">

  <div class="loader" id="loader">
    <svg viewBox="0 0 50 50">
      <circle class="ring" cx="25" cy="25" r="20"></circle>
      <circle class="ball" cx="25" cy="5" r="3.5"></circle>
    </svg>
  </div>

  <div class="comment" id="utteranc"></div>
  <noscript>Please activate JavaScript for normal use of comments</noscript>
</section>

<a class="card back-to-top" id="backTop">&UpArrow;</a>

</main>

    

    <script>
	window.COLD_STONE = {
	  repo: "",
	  gaid: "UA-119658292-2"
	}
</script>


	<script>
		window.COLD_STONE.repo = "xrr2016/blog"
	</script>


<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/highlight.min.js"></script>
<script src="/scripts/cold-stone.js"></script>


  <script src="//www.googletagmanager.com/gtag/js?id=UA-119658292-2"></script>

  <script>
	window.dataLayer = window.dataLayer || []
	function gtag() {
		dataLayer.push(arguments)
	}
	gtag('js', new Date())
	gtag('config', window.COLD_STONE.gaid)
  </script>


  </body>
</html>
